name: AMDESE_AMDSEV_Optimized_v2
on:
  push:
    branches:
      - AMDESE_AMDSEV
  workflow_dispatch:
    inputs:
      AMDSEV_BRANCH:
        description: "Override AMDSEV Branch (optional)"
        required: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AMDSEV_BRANCH: "snp-latest"
  CCACHE_DIR: ${{ github.workspace }}/ccache
  CCACHE_MAXSIZE: 5G

jobs:
  # ============================================================
  # Single Job with Aggressive Caching & Checkpointing
  # ============================================================
  build-with-cache:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Maximize build space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Resolve build versions
        id: versions
        run: |
          AMDSEV_BRANCH="${{ inputs.AMDSEV_BRANCH || env.AMDSEV_BRANCH }}"
          echo "AMDSEV_BRANCH=${AMDSEV_BRANCH}" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "CACHE_KEY=$(date +%Y%m%d)-${AMDSEV_BRANCH}" >> $GITHUB_OUTPUT

      - name: Checkout AMDSEV repository
        uses: actions/checkout@v4
        with:
          repository: AMDESE/AMDSEV
          ref: ${{ steps.versions.outputs.AMDSEV_BRANCH }}
          fetch-depth: 1

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git libssl-dev libelf-dev flex bison bc \
            python3 python3-pip ninja-build meson pkg-config \
            libglib2.0-dev libpixman-1-dev iasl nasm uuid-dev \
            acpica-tools libuuid1 libncurses5-dev wget curl rsync \
            dpkg-dev debhelper dwarves gcc g++ make autoconf automake \
            libtool ccache

      - name: Setup ccache
        run: |
          mkdir -p ${{ env.CCACHE_DIR }}
          ccache --set-config=max_size=${{ env.CCACHE_MAXSIZE }}
          ccache --set-config=compression=true
          ccache --set-config=cache_dir=${{ env.CCACHE_DIR }}
          ccache -z

      # ============================================================
      # Cache Layer 1: ccache (compilation cache)
      # ============================================================
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-all-${{ steps.versions.outputs.CACHE_KEY }}-${{ github.run_number }}
          restore-keys: |
            ccache-all-${{ steps.versions.outputs.CACHE_KEY }}-
            ccache-all-

      # ============================================================
      # Cache Layer 2: OVMF source and build
      # ============================================================
      - name: Cache OVMF
        uses: actions/cache@v4
        with:
          path: |
            ovmf/
            usr/local/share/qemu/
          key: ovmf-${{ steps.versions.outputs.AMDSEV_BRANCH }}-${{ hashFiles('**/stable-commits') }}
          restore-keys: |
            ovmf-${{ steps.versions.outputs.AMDSEV_BRANCH }}-

      # ============================================================
      # Cache Layer 3: QEMU source and build
      # ============================================================
      - name: Cache QEMU
        uses: actions/cache@v4
        with:
          path: |
            qemu/
            usr/local/bin/qemu-*
            usr/local/share/qemu/
          key: qemu-${{ steps.versions.outputs.AMDSEV_BRANCH }}-${{ hashFiles('**/stable-commits') }}
          restore-keys: |
            qemu-${{ steps.versions.outputs.AMDSEV_BRANCH }}-

      # ============================================================
      # Cache Layer 4: Linux source (host and guest share same source)
      # ============================================================
      - name: Cache Linux source
        uses: actions/cache@v4
        with:
          path: linux/
          key: linux-src-${{ steps.versions.outputs.AMDSEV_BRANCH }}-${{ hashFiles('**/stable-commits') }}
          restore-keys: |
            linux-src-${{ steps.versions.outputs.AMDSEV_BRANCH }}-

      - name: Display system information
        run: |
          echo "=== System Information ==="
          uname -a
          df -h
          free -h
          nproc
          gcc --version
          echo "=== Cache Status ==="
          ccache -s

      # ============================================================
      # CHECKPOINT 1: Build OVMF (~15-30 min first time, <5 min cached)
      # ============================================================
      - name: Build Stage 1 - OVMF
        id: ovmf
        continue-on-error: true
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache gcc"
          export CXX="ccache g++"
          
          echo "=== Building OVMF ==="
          # The build.sh script will skip if already built
          timeout 45m ./build.sh --package 2>&1 | tee -a build.log | grep -E "(OVMF|ovmf|Building|Error|error)" || true
          
          # Check if OVMF exists
          if [ -d "usr/local/share/qemu" ] && ls usr/local/share/qemu/OVMF*.fd 2>/dev/null; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "✓ OVMF available"
          fi
          
          # Upload checkpoint
          mkdir -p checkpoints/ovmf
          cp -r usr/local/share/qemu/*.fd checkpoints/ovmf/ 2>/dev/null || true

      - name: Upload OVMF checkpoint
        if: steps.ovmf.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: checkpoint-ovmf-${{ steps.versions.outputs.BUILD_DATE }}
          path: checkpoints/ovmf/
          retention-days: 1

      # ============================================================
      # CHECKPOINT 2: Build QEMU (~30-45 min first time, ~10 min cached)
      # ============================================================
      - name: Build Stage 2 - QEMU
        id: qemu
        continue-on-error: true
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache gcc"
          export CXX="ccache g++"
          
          echo "=== Building QEMU ==="
          timeout 60m ./build.sh --package 2>&1 | tee -a build.log | grep -E "(qemu|QEMU|Building|Error|error)" || true
          
          # Check if QEMU exists
          if [ -f "usr/local/bin/qemu-system-x86_64" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "✓ QEMU available"
            usr/local/bin/qemu-system-x86_64 --version || true
          fi
          
          # Upload checkpoint
          mkdir -p checkpoints/qemu
          cp -r usr/local/bin/qemu-* checkpoints/qemu/ 2>/dev/null || true
          
          ccache -s

      - name: Upload QEMU checkpoint
        if: steps.qemu.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: checkpoint-qemu-${{ steps.versions.outputs.BUILD_DATE }}
          path: checkpoints/qemu/
          retention-days: 1

      # ============================================================
      # CHECKPOINT 3: Build Kernels (~120-180 min first time, ~30-40 min cached)
      # ============================================================
      - name: Build Stage 3 - Kernels
        id: kernels
        continue-on-error: true
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          export CC="ccache gcc"
          
          echo "=== Building Kernels ==="
          # Continue or restart the build - it will build kernels
          timeout 180m ./build.sh --package 2>&1 | tee -a build.log | grep -E "(kernel|Kernel|linux|Linux|Building|Error|error|\[.*\])" || true
          
          # Check results
          RELEASE_DIR=$(ls -d snp-release-* 2>/dev/null | head -n 1)
          if [ -n "$RELEASE_DIR" ]; then
            echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV
            echo "success=true" >> $GITHUB_OUTPUT
            
            echo "=== Build Results ==="
            ls -lah "$RELEASE_DIR/" || true
            ls -lah "$RELEASE_DIR/linux/host/" 2>/dev/null || true
            ls -lah "$RELEASE_DIR/linux/guest/" 2>/dev/null || true
          fi
          
          ccache -s

      - name: List kernel packages
        if: env.RELEASE_DIR != ''
        run: |
          echo "=== Host Kernel Packages ==="
          ls -lh "${{ env.RELEASE_DIR }}/linux/host/" 2>/dev/null || echo "No host packages found"
          
          echo "=== Guest Kernel Packages ==="
          ls -lh "${{ env.RELEASE_DIR }}/linux/guest/" 2>/dev/null || echo "No guest packages found"

      - name: Upload kernel checkpoint
        if: steps.kernels.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: checkpoint-kernels-${{ steps.versions.outputs.BUILD_DATE }}
          path: |
            ${{ env.RELEASE_DIR }}/linux/
          retention-days: 1
          if-no-files-found: warn

      # ============================================================
      # Final: Create release package
      # ============================================================
      - name: Create artifact archive
        if: env.RELEASE_DIR != ''
        run: |
          tar -czf snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz "${{ env.RELEASE_DIR }}"
          ls -lh snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz
          sha256sum snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz > snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz.sha256
          md5sum snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz > snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz.md5

      - name: Upload build artifacts
        if: env.RELEASE_DIR != ''
        uses: actions/upload-artifact@v4
        with:
          name: snp-release-${{ steps.versions.outputs.BUILD_DATE }}
          path: |
            snp-release-*.tar.gz
            snp-release-*.tar.gz.sha256
            snp-release-*.tar.gz.md5
          retention-days: 90
          compression-level: 0

      - name: Upload kernel packages separately
        if: env.RELEASE_DIR != ''
        uses: actions/upload-artifact@v4
        with:
          name: kernel-packages-${{ steps.versions.outputs.BUILD_DATE }}
          path: |
            ${{ env.RELEASE_DIR }}/linux/host/*.deb
            ${{ env.RELEASE_DIR }}/linux/guest/*.deb
          retention-days: 90
          if-no-files-found: warn

      - name: Generate build summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # AMD SEV-SNP Build Summary
          
          ## Build Information
          - **Date**: ${{ steps.versions.outputs.BUILD_DATE }}
          - **Branch**: ${{ steps.versions.outputs.AMDSEV_BRANCH }}
          
          ## Build Stages Status
          - **OVMF**: ${{ steps.ovmf.outputs.success == 'true' && '✅ Success' || '❌ Failed/Skipped' }}
          - **QEMU**: ${{ steps.qemu.outputs.success == 'true' && '✅ Success' || '❌ Failed/Skipped' }}
          - **Kernels**: ${{ steps.kernels.outputs.success == 'true' && '✅ Success' || '❌ Failed/Skipped' }}
          
          ## Cache Statistics
          \`\`\`
          $(ccache -s 2>/dev/null || echo "ccache stats not available")
          \`\`\`
          
          ## Artifacts
          - Complete release: \`snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz\`
          - Kernel packages available separately
          - Checkpoints saved for failed stages
          EOF
          
          # Show last 100 lines of build log for debugging
          if [ -f build.log ]; then
            echo "## Build Log (last 100 lines)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -100 build.log >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload full build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ steps.versions.outputs.BUILD_DATE }}
          path: build.log
          retention-days: 30
          if-no-files-found: warn

      - name: Create GitHub Release
        if: github.event_name == 'workflow_dispatch' && env.RELEASE_DIR != ''
        uses: softprops/action-gh-release@v1
        with:
          files: |
            snp-release-*.tar.gz
            snp-release-*.tar.gz.sha256
            snp-release-*.tar.gz.md5
          tag_name: build-${{ steps.versions.outputs.BUILD_DATE }}-${{ github.run_number }}
          name: AMD SEV-SNP Build ${{ steps.versions.outputs.BUILD_DATE }}
          body: |
            # AMD SEV-SNP Build
            
            **Branch**: ${{ steps.versions.outputs.AMDSEV_BRANCH }}
            **Build Date**: ${{ steps.versions.outputs.BUILD_DATE }}
            
            ## Build Status
            - OVMF: ${{ steps.ovmf.outputs.success == 'true' && '✅' || '❌' }}
            - QEMU: ${{ steps.qemu.outputs.success == 'true' && '✅' || '❌' }}
            - Kernels: ${{ steps.kernels.outputs.success == 'true' && '✅' || '❌' }}
            
            ## Installation
            ```bash
            tar -xzf snp-release-${{ steps.versions.outputs.BUILD_DATE }}.tar.gz
            cd snp-release-*/
            sudo ./install.sh
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
